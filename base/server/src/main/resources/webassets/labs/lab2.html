<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <title>BASE Lab 2 Manual</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="header.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="header.js"></script>
    <script src="lab2.js"></script>
    <script src="../rest.js"></script>
</head>
<body>
<div id="header"></div>

<div class="container">
    <h1 class="display-2">BASE Lab Manual:</h1>
    <h1>Lab 2 Back End</h1>
    <h4 class="text-muted mt-3">Created by Rasmus Ros in 2018,
        <a href="mailto:rasmus.ros@cs.lth.se?Subject=Lab%20rant">rasmus.ros@cs.lth.se</a>,
        for the course in Large Scale Software Engineering at LTH, Lund University.</h4>
    <p class="lead mt-3">
        This lab continues the introduction of the BASE System, the progression is as follows:
        H2 database, REST, Jetty and Jersey, and then a final end-to-end task that expands on the previous lab.
        It might be useful to review the <a href="lab1.html#BASE">system overview</a> of the previous lab.
    </p>

    <!--  ***********************************************************************************************
          Server Overview.
          *********************************************************************************************** -->
    <section class="lab-section">
        <a class="anchor" name="Server"></a>
        <h1>Server Overview</h1>
        <p>
            The code in BASE is organized in a
            <a href="https://en.wikipedia.org/wiki/Multitier_architecture" target="_blank">three-tier architecture</a>.
            The top tier is the user interface, the web front end (or e.g. an Android client). The middle tier is the
            REST API definitions, implemented by Jersey in Java, the final tier is the Java code interfacing the H2
            database. The bottom two layers are represented in different classes even though they conceptually belong
            together. FooDataAccess.java and FooResource.java are split into separate classes even though they deal with
            similar things.
            The purpose of separating code in this way is that it is easier to perform unit testing of them and that
            they can be easily replaced or worked on separately. The principle is called
            <a href="https://en.wikipedia.org/wiki/Loose_coupling" target="_blank">loose coupling</a>.
        </p>
        <p>
            <b>Note!</b> This hierarchy does not reflect the size of the codebase or the difficulty of the programming
            involved.
        </p>
        <figure>
            <img src="Overview_of_a_three-tier_application_vectorVersion.svg"
                 class="img-fluid mx-auto d-block">
            <figcaption class="mx-auto d-block figure-caption" style="text-align: center">
                Example of a three-tier architecture, the corresponding parts in BASE are added in red.
                <a href="https://en.wikipedia.org/wiki/Multitier_architecture#/media/File:Overview_of_a_three-tier_application_vectorVersion.svg"
                   target="_blank">Source.</a>
            </figcaption>
        </figure>

    </section>

    <!--  ***********************************************************************************************
         H2 Database
         *********************************************************************************************** -->
    <section class="lab-section">
        <a class="anchor" name="H2SQL"></a>
        <h1>H2 Database</h1>
        <p>
            H2 is a relational database that is accessed using Structured Query Language (SQL) queries. A relational
            database has tables with columns. The columns can have relations to other columns in other tables.
            The columns are pre-defined and all rows must conform to the pre-defined structure, known as a
            <em>schema</em>. Beyond this document, here are some references to learn more about SQL and H2.
        </p>
        <ul>
            <li><a href="http://www.h2database.com/html/grammar.html" target="_blank">H2 API reference</a></li>
            <li><a target="_blank" href="http://cs.lth.se/edaf75/">EDAF75 - Course in database technology</a>
                (go here for tutorials, books, etc.)
            </li>
        </ul>
        <p>
            Below is an example of the table used for storing the data for <em>foo</em> rows.
        </p>
        <table class="table table-sm table-striped">
            <tr class="thead-dark">
                <th>foo_id</th>
                <th>payload</th>
                <th>user_id</th>
                <th>created</th>
            </tr>
            <tr>
                <td>1</td>
                <td>a</td>
                <td>2</td>
                <td>2018-05-16T06:37:56.446493Z</td>
            </tr>
            <tr>
                <td>2</td>
                <td>b</td>
                <td>2</td>
                <td>2018-05-16T06:37:56.446494Z</td>
            </tr>
            <tr>
                <td>3</td>
                <td>c</td>
                <td>2</td>
                <td>2018-05-16T06:37:56.446495Z</td>
            </tr>
            <tr>
                <td>4</td>
                <td>d</td>
                <td>2</td>
                <td>2018-05-16T06:37:56.446496Z</td>
            </tr>
            <tr>
                <td>5</td>
                <td>e</td>
                <td>1</td>
                <td>2018-05-16T06:37:56.446497Z</td>
            </tr>
            <tr>
                <td>6</td>
                <td>f</td>
                <td>1</td>
                <td>2018-05-16T06:37:56.446498Z</td>
            </tr>
        </table>
        <p>
            When the schema is defined, the types of the various columns are also defined. For example, the types of the
            above table are: <code>INT</code> for foo_id, <code>VARCHAR</code> for payload, <code>INT</code> for
            user_id, <code>TIMESTAMP</code> for created. <code>VARCHAR</code> is the SQL name for String in Java. See
            the <a href="http://www.h2database.com/html/datatypes.html" target="_blank">H2 API reference</a> for all
            types that H2 support. The database will make sure that only values that match the correct format for the
            types can be entered into the database.
        </p>
        <p>
            In the example above, the <code>user_id</code> column refers to another table. Note that it does not store
            the actual username, only the unique identifier of the user. In this way, the username can be changed
            without changing all the data rows. This is an example of
            <a href="https://en.wikipedia.org/wiki/Database_normalization">normalization</a>.
        </p>
        <p>
            Many databases must be installed and come equipped with a graphical interface for accessing
            it. In this course we will use H2 as an embedded database that is used as a library. You still have the
            option of using a graphical interface though, which we will now demonstrate through a task.
        </p>

        <div class="lab-task-group alert alert-warning" id="h2Gui">
            <h4 class="alert-heading">Try out the H2 graphical interface</h4>
            <div class="alert alert-info">
                <b>Note on Maven!</b>
                For this task you need to execute a specific command in Maven. It is the build tool used by Base to
                download the library dependencies, and for building a fat jar (jar with all dependencies, like a self
                contained file). It can be installed on any machine, but is already installed on the lab computers. In
                addition, it comes bundled in Eclipse and Intellij. If you are on a windows machine and failed to
                install Maven, you can execute the package goal in Maven through Eclipse instead to create the fat-jar.
            </div>
            <ol>
                <li>Make sure the BASE server is closed to release the lock on the database.</li>
                <li>Open a console terminal, in Linux or MacOS (the commands for Windows are slightly different), and
                    execute these commands:</li>
            </ol>
            <pre><code class="language-bash">
                > cd ~/ROOT_DIR/base/server       # Replace ROOT_DIR with the directory you cloned the repository to
                > mvn clean package               # This will build your project so that the H2 interface can be executed
                > java -cp target/base-server-jar-with-dependencies.jar org.h2.tools.Console
            </code></pre>
            <ol start="3">
                <li>The console will now be open in your browser.</li>
                <li>Enter <code>jdbc:h2:~/base-server/data</code> into the <code>JDBC URL</code> input.</li>
                <li>Click the <q>Connect</q> button.</li>
                <li>Enter this query into the large text area:</li>
            </ol>
            <pre><code class="language-sql">
                SELECT username FROM users
                WHERE user_id = 1
            </code></pre>
            <ol start="6">
                <li>Click the <q>Run</q> button to execute the query.</li>
                <li>What is the result of the query?</li>
            </ol>
            <div class="lab-task-form">
                <div class="form-check">
                    <form onsubmit="return h2GuiValidate(event)" class="lab-task-form">
                        <div class="form-group">
                            <input class="form-control" type="text" placeholder="input query result" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Validate</button>
                    </form>
                </div>
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
                <hr>
            </div>
            <ol class="mt-3" start="8">
                <li class="language-sql">
                    You might also want to execute these queries (one at a time) to see what is stored in the rest of
                    the tables:<br>
                    <code>SELECT * FROM users</code><br>
                    <code>SELECT * FROM foo</code><br>
                    <code>SELECT * FROM user_role</code><br>
                    <code>SELECT * FROM session</code>
                </li>
                <li>Go back to the terminal and kill the program using Ctrl+C.</li>
                <li>Restart the BASE server.</li>
            </ol>
        </div>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="SQL"></a>
            <h3 class="mt-3">SQL Basics</h3>
            <p>
                SQL is a language for manipulating the data in the relational database. By now you have already tried
                <code class="language-sql">SELECT</code> SQL query statement. There are more types of statements in the
                SQL standard, the ones you should know in the project are included below.
            </p>
            <div class="alert alert-info">
                <b>Note!</b> SQL is a very useful skill to have in many professions, even outside software engineering
                and IT operations. Many data sets are stored in relational databases and must be accessed with SQL
                queries. As such, knowing SQL is essential for business analysts, data scientists/engineers,
                quantitative researchers, etc. SQL can be used to aggregate, sort, and slice such data sets in order to
                produce statistics and reports.
            </div>

            <dl class="row language-sql">
                <dt class="col-sm-3"><code>INSERT query</code></dt>
                <dd class="col-sm-9">
                    To add new data into the database the <code>INSERT</code> statement is used. Below is an example of
                    inserting a row into the foo table.
                    <pre><code>
                        INSERT INTO foo VALUES (41, 'data', 2, '2018-05-15 16:02:49')
                    </code></pre>
                    Some values can be omitted if they have default values specified in the schema. In that case, the
                    syntax is as follows.
                    <pre><code>
                        INSERT INTO foo (payload, user_id) VALUES ('data', 2)
                    </code></pre>
                </dd>
                <dt class="col-sm-3"><code>SELECT query</code></dt>
                <dd class="col-sm-9">
                    Used to query for rows from the database. A select statement never alters the data in the database.
                    Example of an select statement that fetches all rows in the table:
                    <pre><code>SELECT * FROM foo</code></pre>
                    The asterix can be replaced by an enumeration of columns, like so:
                    <pre><code>SELECT payload, user_id FROM foo</code></pre>
                    It is possible to select data from multiple tables in one query. The simplest form of this is
                    through what is known as implicit join.
                    <pre><code>SELECT * FROM foo, user</code></pre>
                    In that case, all the returned rows will have the corresponding data from the user table added to
                    it. Since all foo's have a user, but all users might not have foo, the query does not return all
                    users, but it does return all foo's. You can filter which columns to return when using an implicit
                    join like so:
                    <pre><code>SELECT foo.*, user.user_name FROM foo, user</code></pre>
                    The example returns everything from the foo table but only user_name from the foo table.
                </dd>
                <dt class="col-sm-3"><code>WHERE clause</code></dt>
                <dd class="col-sm-9">
                    Add optional additional qualifiers to <code>SELECT</code>, <code>UPDATE</code>, and
                    <code>DELETE</code> queries with the <code>WHERE</code> clause. The operation will only be performed
                    on those rows that match the test.
                    <pre><code>
                        SELECT * FROM foo
                        WHERE user_id = 2
                    </code></pre>
                    Other operators can also be used, such as &lt;, &gt;, and &lt;&gt; (not equals). Additionally,
                    multiple operators can be combined with <code>OR</code> and <code>AND</code>.
                    <p>
                        This can also be used to modify a SELECT query to fetch results from multiple tables. For
                        example:
                    </p>
                    <pre><code>
                        SELECT foo.*, user.username FROM foo, user
                        WHERE user.user_id = 2 AND foo.user_id = user.user_id
                    </code></pre>
                </dd>
                <dt class="col-sm-3"><code>UPDATE query</code></dt>
                <dd class="col-sm-9">
                    Updating an existing table is done through the <code>UPDATE</code> statement. An example follows.
                    <pre><code>
                        UPDATE foo SET payload = 'New payload'
                        WHERE foo_id = 41
                    </code></pre>
                    <p>Multiple columns can be updated after the <code>SET</code> keyword with a comma separated list.
                    </p>
                </dd>
                <dt class="col-sm-3"><code>DELETE query</code></dt>
                <dd class="col-sm-9">
                    Finally, the <code>DELETE</code> statement is used to remove rows from the database.
                    As an example, this will delete all foo data from a user with id 2:
                    <pre><code>
                        DELETE FROM foo
                        WHERE user_id = 2
                    </code></pre>
                </dd>
            </dl>

            <section class="alert alert-info lab-section-optional">
                <details>
                    <summary>
                        Aggregating Queries Teaser
                    </summary>
                    <p>
                        SQL has very powerful syntax for performing data aggregations. Let's illustrate with an example:
                    </p>
                    <pre><code class="language-sql">
                        SELECT user.username, COUNT(foo.user_id) FROM users
                        LEFT JOIN foo ON foo.user_id = user.user_id
                        GROUP BY user.user_id
                        ORDER BY user.username
                    </code></pre>
                    <p>
                        This counts the number of foo's for each user, the result of the query might be something like
                        this:
                    </p>

                    <table class="table table-sm table-striped bg-light">
                        <tr class="thead-dark">
                            <th>COUNT(foo.user_id)</th>
                            <th>username</th>
                        </tr>
                        <tr>
                            <td>Admin</td>
                            <td>9</td>
                        </tr>
                        <tr>
                            <td>Test</td>
                            <td>11</td>
                        </tr>
                        <tr>
                            <td>Newbie</td>
                            <td>0</td>
                        </tr>
                    </table>
                    <p>
                        The example introduced a lot of new types of functions and clauses: COUNT, LEFT JOIN, GROUP BY,
                        and ORDER BY. You will have to figure out the specifics of how to use these functions on your
                        own.
                    </p>
                </details>
            </section>

            <div class="lab-task-group language-sql alert alert-warning" id="sqlSelect">
                <h4 class="alert-heading">
                    Which query is correct?
                </h4>
                <p>Which of these queries will return all columns from the USER table with the username 'Test'?</p>
                <div class="lab-task-form">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlSelect', 1)" class="form-check-input" type="radio"
                                   name="sqlSelect">
                            <code>SELECT VALUES FROM users WHERE username='Test' </code>
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlSelect', 2)" class="form-check-input" type="radio"
                                   name="sqlSelect">
                            <code>SELECT * FROM users WHERE username='Test'</code>
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlSelect', 3)" class="form-check-input" type="radio"
                                   name="sqlSelect">
                            <code>SELECT * FROM users JOIN ON username='Test'</code>
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlSelect', 4)" class="form-check-input" type="radio"
                                   name="sqlSelect">
                            <code>SELECT username='Test' FROM users</code>
                        </label>
                    </div>
                </div>
                <div class="lab-task-completed">
                    <hr>
                    Right, well done!
                </div>
                <div class="lab-task-error alert alert-danger">
                    Incorrect, try again.
                </div>
            </div>

            <div class="lab-task-group language-sql alert alert-warning" id="sqlQuery">
                <h4 class="alert-heading">
                    What does this query do?
                </h4>
                <pre><code class="language-sql">
                    SELECT user_role.role FROM users, user_role
                    WHERE username = 'Admin'
                        AND password_hash = '8dc0e2ab-4bf1-7671-c0c4-d22ffb55ee59'
                        AND user_role.role_id = user.role_id
                </code>
                </pre>

                <div class="lab-task-form">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlQuery', 1)" class="form-check-input" type="radio"
                                   name="sqlQuery">
                            Adds the default user_role to the matching user.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlQuery', 2)" class="form-check-input" type="radio"
                                   name="sqlQuery">
                            Selects the data from all columns in user of the matching user.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlQuery', 3)" class="form-check-input" type="radio"
                                   name="sqlQuery">
                            Updates the password_hash of the matching user.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input onclick="baseLab.complete('sqlQuery', 4)" class="form-check-input" type="radio"
                                   name="sqlQuery">
                            Returns the user_role.role of the matching username and password.
                        </label>
                    </div>
                </div>
                <div class="lab-task-completed">
                    <hr>
                    Right, well done!
                </div>
                <div class="lab-task-error alert alert-danger">
                    Incorrect, try again.
                </div>
            </div>
        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="SQLBASE"></a>
            <h3>SQL in BASE</h3>
            <p>
                There is a built in API in Java for accessing databases through SQL, called
                <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/index.html" target="_blank">JDBC</a>.
                This API existed before many modern Java features (like lambdas or generics), so the code requires a lot
                of boilerplate.
            </p>
            <p>
                Here is an example that executes a query and populates a list with Java objects from the database.
                This specific statement is used in the actual BASE server to populate the table of foos for a user (with
                user_id = 2 in this case).
            </p>
            <pre><code class="language-java">
                String driverUrl = "jdbc:h2:~/base-server/data";
                List&lt;Foo&gt; foos = new ArrayList<>();
                try (Connection connection = DriverManager.getConnection(driverUrl, "sa", "");
                    PreparedStatement statement = connection.prepareStatement("SELECT * FROM foo WHERE user_id = ?");) {
                    // This question mark is a dynamic parameter to the query: --------------------------------- ^
                    // The parameter is set as below:
                    statement.setInt(1, 2); // The first parameter is set to 2
                    // The final SQL statement will be as such: SELECT * FROM foo WHERE user_id = 2

                    // A ResultSet in JDBC holds the query results
                    try (ResultSet resultSet = statement.executeQuery();) {
                        // The ResultSet is looped through and converted to plain Java objects below
                        while (resultSet.next()) {
                            int fooId = resultSet.getInt("foo_id");
                            int userId = resultSet.getInt("user_id");
                            String payload = resultSet.getString("payload");
                            long timestamp = resultSet.getObject("created", Date.class).getTime();
                            Foo foo = new Foo(fooId, userId, payload, timestamp);
                            foos.add(foo);
                        }
                    }
                } catch (SQLException exception) {
                    // Handle exceptions somehow or add exception to method signature
                }
            </code></pre>
            <p>
                To make such queries shorter to write we have a helper class that has much of the boilerplate already
                defined. Below is the same example using the
                <code>server/src/main/java/se/lth/base/server/database/DataAccess.java</code> class. We introduce an
                interface here that is used to do the mapping from <code>ResultSet</code>s to standard Java objects in a
                re-usable way.
            </p>
            <pre><code class="language-java">
                public interface Mapper&lt;T&gt; {
                    T map(ResultSet resultSet) throws SQLException;
                }
            </code></pre>
            <pre><code class="language-java">
                String driverUrl = "jdbc:h2:~/base-server/data";
                Mapper&lt;Foo&gt; mapper = new Mapper&lt;Foo&gt;() {
                    @Override
                    public Foo map(ResultSet resultSet) throws SQLException {
                        return new Foo(resultSet.getInt("foo_id"),
                                resultSet.getInt("user_id"),
                                resultSet.getString("payload"),
                                resultSet.getObject("created", Date.class).getTime());
                    }
                };
                DataAccess&lt;Foo&gt; fooDao = new DataAccess&lt;&gt;(driverUrl, mapper);
                List&lt;Foo&gt; foos = fooDao.query("SELECT * FROM foo WHERE user_id = ?", 2);
            </code></pre>
            <p>
                The major benefit of this is that the same data access object can be re-used for many queries. That is,
                without changing the Mapper.
            </p>
            <p>
                There are a few more helper functions in the DataAccess&lt;T&gt; class: <code>queryFirst: T</code> for
                select on a single row, <code>&lt;S&gt; insert: S</code> for getting auto generated keys,
                <code>execute: int</code> for counting how many rows were affected by an update/insert.
            </p>
            <pre><code class="language-java">
                // Continuing on the example above

                // The method insert returns an auto generated id
                // (if there is nothing that is auto generated, then use execute instead)
                int autoGeneratedFooId = fooDao.insert("INSERT INTO foo (user_id, payload) VALUES (?,?)", 2, "data");

                // Execute returns number of rows changed, which will be one in this case.
                int numberRowsChanged = fooDao.execute("UPDATE foo SET payload = ? WHERE foo_id = ?", "changed my mind", autoGeneratedFooId);

                // Finally queryFirst returns the first item in the stream or throws an exception if there is none.
                Foo foo = fooDao.queryFirst("SELECT * FROM foo WHERE foo_id = ?", autoGeneratedFooId);
            </code></pre>
            <p>
                See <code>base/server/src/main/java/se/lth/base/server/data/FooDataAccess.java</code> and
                <code>base/server/src/test/java/se/lth/base/server/data/FooDataAccessTest.java</code> for the database
                code concerning foo.
            </p>

            <div class="lab-task-group language-sql alert alert-warning" id="sqlBase">
                <h4 class="alert-heading">
                    What is the purpose of enforcing the Mapper interface?
                </h4>

                <p>
                    An implementing class of the Mapper interface should implement the <code>map: T</code> method. It
                    should return an object for a row in the ResultSet. Why is this a good idea? Check all that apply.
                </p>

                <form onsubmit="return sqlBaseValidate(event)" class="lab-task-form">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="1" class="form-check-input" type="checkbox" name="sqlBase">
                            It reduces the risk for errors with resources that must be closed: Connection,
                            PreparedStatement, and the ResultSet.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="2" class="form-check-input" type="checkbox" name="sqlBase">
                            The SQL query is optimized for better performance when done through a single method call.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="3" class="form-check-input" type="checkbox" name="sqlBase">
                            It provides a structure for code reuse between multiple methods in the data access class.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="4" class="form-check-input" type="checkbox" name="sqlBase">
                            It facilitates default error handling of the checked exception SQLException. Otherwise each
                            query would have to have a try/catch block.
                        </label>
                    </div>
                    <button type="submit" class="mt-3 btn btn-primary">Validate</button>
                </form>

                <div class="lab-task-completed">
                    <hr>
                    Right, well done!
                </div>
                <div class="mt-3 lab-task-error alert alert-danger">
                    Incorrect, try again.
                </div>
            </div>

        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="Schema"></a>
            <h3 class="mt-3">Database Schema</h3>
            <p>
                A database schema is the skeleton structure that is used by the whole database. The schema defines
                constraints that enforces data integrity, how data is organized, and the relations between tables. The
                schema is created with SQL queries. A table in the schema is created through the
                <code class="language-sql">CREATE TABLE</code> query. Below is an excerpt from the schema used in BASE
                that
                creates the foo table.
            </p>
            <pre><code class="language-sql">
                -- Example table containing some data per user, you are expected to remove this table in your project.
                CREATE TABLE foo(
                    -- First the four columns are specified:

                    foo_id INT AUTO_INCREMENT,
                    -- foo_id is the first column with type INT. This is used to uniquely identify each foo. In this way, the foo can be
                    -- deleted or updated by referring only to its foo_id. The AUTO_INCREMENT keyword is H2 specific and indicates
                    -- that the column is supplied with a default value that is incremented for each row. The first row
                    -- will automatically get foo_id = 1, the second one will get foo_id = 2, and so on.

                    payload VARCHAR NOT NULL,
                    -- payload is the second column with type VARCHAR. This is the data that is typed in the input field
                    -- on the foo tab in the front end. There is no limit to how long the string can be.
                    -- NOT NULL specifies that the row must have a payload.

                    user_id INT NOT NULL,
                    -- user_id is the third column with type INT. This keeps track of who the user is, so that each user has their own
                    -- foos only.

                    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP() NOT NULL,
                    -- created is the fourth and final column with type TIMESTAMP. This column also has a default value
                    -- which is created by the function CURRENT_TIMESTAMP() if not supplied during creation.

                    -- Here are some additional constraints that the data must relate to:

                    PRIMARY KEY(foo_id),
                    -- This defines foo_id as the unique identifier of the table. It adds NOT NULL to the column and
                    -- enforces that the values rows all have a unique identifier.

                    FOREIGN KEY(user_id) REFERENCES user(user_id) ON DELETE CASCADE
                    -- This informs that the column user_id is a relation to another table's primary key. In combination
                    -- with the NOT NULL constraint above it is not possible to enter data that is not connected to a user.
                    -- Note that there can be multiple rows with the same user_id (but the foo_id is unique for each row).
                    -- The ON DELETE CASCADE ensures that when a user is deleted then all their foo data will also be deleted.
                );
            </code></pre>
            <p>
                The statements are contained in a file:
                <code>base/server/main/resources/se/lth/base/server/database/schema.sql</code>.
                By default the schema will be installed into a directory in your home directory when the BASE server is
                started for the first time, the directory is located in : <code>~/base-server</code>.
                There is also a main Java class that executes the schema:
                <code>base/server/main/java/se/lth/base/server/database/CreateSchema.java</code>.
                If you make changes to the schema file, these changes are only implemented by running the main method in the
                CreateSchema class, which loads the file and runs the statements.
            </p>

            <div class="lab-task-group language-sql alert alert-warning" id="sqlSchema">
                <h4 class="alert-heading">
                    Which statements about SQL keys are true?
                </h4>
                <p>
                    Check all that applies.
                </p>

                <form onsubmit="return sqlSchemaValidate(event)" class="lab-task-form">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="1" class="form-check-input" type="checkbox" name="sqlSchema">
                            Primary keys uniquely identify a row in a table.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="2" class="form-check-input" type="checkbox" name="sqlSchema">
                            Foreign keys cannot accept NULL values.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="3" class="form-check-input" type="checkbox" name="sqlSchema">
                            There can be only one primary key but multiple foreign key references.
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input value="4" class="form-check-input" type="checkbox" name="sqlSchema">
                            There must be a primary key in each table.
                        </label>
                    </div>
                    <button type="submit" class="mt-3 btn btn-primary">Validate</button>
                </form>

                <div class="lab-task-completed">
                    <hr>
                    Right, well done!
                </div>
                <div class="mt-3 lab-task-error alert alert-danger">
                    Incorrect, try again.
                </div>
            </div>
        </section>

        <section class="alert alert-info lab-section-optional">
            <details>
                <summary>
                    Indices
                </summary>
                <p>
                    To have a well performing SQL database under reasonable load indices are required. An index is added
                    to a table with a list of specific columns that are included in the index. A query can then hit or
                    miss an index. Ideally no queries should miss indices all together.
                    For example, an index on foo's user_id would be needed in order for select queries
                    like this to hit an index:
                </p>
                <pre><code class="language-sql">SELECT * FROM foo WHERE user_id = 1</code></pre>
                <p>
                    The syntax for adding an index that supports the query above in H2 is as follows.
                </p>
                <pre><code class="language-sql">CREATE INDEX foo_user_id_idx ON foo(user_id)</code></pre>
                <p>
                    Note that primary keys are indexed by default. As such, a query for a primary key will always hit an
                    index.
                </p>
            </details>
        </section>


        <section class="lab-sub-section">
            <a class="sub-anchor" name="H2Test"></a>
            <h3 class="mt-3">H2 Unit Tests</h3>
            <p>
                H2 has the option of placing the entire database in-memory which is very useful for testing purposes.
                Database tests in BASE should extend
                <code>base/server/src/test/se/lth/base/server/database/BaseDataAccessTest.java</code> to create a
                temporary database for each test. Thus, each unit test has an isolated fresh copy of the schema.
            </p>
        </section>
    </section>

    <!--  ***********************************************************************************************
           REST, HTTP, and JSON
           *********************************************************************************************** -->
    <section class="lab-section">
        <a class="anchor" name="REST"></a>
        <h1>REST</h1>
        <p>
            The BASE server is an API for the Android client and the web client. The API follows the
            <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">
                Representational state transfer (REST)</a> architectural style. The
            <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm" target="_blank">
                original REST</a> principles are hard to achieve to in practice, leading to RESTful APIs that exhibit
            some of the REST principles.
            <a href="https://restfulapi.net/rest-architectural-constraints/" target="_blank">Here</a> is a nice
            description of the REST principles and design constraints.
            Another interesting read is the
            <a href="https://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank">maturity model</a>
            of REST APIs.
            An introduction to some of the REST principles and constraints follows.
        </p>
        <p>
            A <b>client</b> is the person or software that uses the API, i.e. the web front end or Android client.
            <b>Resources</b> are types of data that are manipulated through the API calls. For example,
            <em>users</em> and <em>foo</em>. Each resource is identified through a unique identifier.
            Both users and foos have integer ids: <a target="_blank" href="/rest/user/1">/rest/user/1</a> fetches the
            user with id 1. As with method names in Java, it does not matter what they are named, just ensure that you
            follow some consistent style to avoid confusion. <code>/rest/user/id/1</code> would also be fine.
        </p>
        <p>
            As evident from the REST name, client state should not be maintained on the server between requests.
            The result of an API call should be the same regardless of which client context it has. That is,
            <code>/user/1</code> should be the same resource as another call to <code>/user/1</code> at another time or
            by another user, unless the resource itself has changed. It should not matter if the client is coming from
            this or that part of the application before performing the request. In practice, many REST APIs (including
            BASE) make <em>one</em> exception to this principle to handle authorization.
        </p>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="HTTP"></a>
            <h3>HTTP Basics</h3>
            <p>
                HTTP is an application protocol for transferring information across the internet. A HTTP request is
                issued to a server using a <em>header</em> and an optional <em>body</em>. The header must have a
                Uniform Resource Identifier (URI), a <em>verb</em>, and a version indicator. The URI identifies which
                resource to do something with, and the verb what to do with that resource.
                In addition there are header parameters that can be set, most importantly Cookie and Content-Type.
                Content-Type decides which data format is used to send information back and forth. In BASE the Cookie
                keeps track of the logged in session, without the Cookie the user is not authorized to perform most
                operations.
            </p>
            <p>
                After a client request, a <em>response</em> is returned to the client. It also has a header and an
                optional body. However, instead of a verb the server has <em>status codes</em>. Many are already
                familiar with some of the HTTP status codes, such as <code>404</code>, which is issued when a resource
                cannot be found.
            </p>
            <p>
                Below is an example of an HTTP request/response that is issued when a user submits a new foo in
                BASE. You can see many more examples of HTTP request/responses through your web browsers console, in the
                network tab.
            </p>
            <h4>Example HTTP request/response</h4>
            <p>
                The request in this example performs a POST towards the URL http://localhost:8080/rest/foo. It sends
                along a request body which is a JSON object. As response from BASE the client receives status OK and
                an updated resource. This is the HTTP request/response that will be performed on the starting page of
                BASE, when you submit a new foo.
                Note that the bolded header to the left is not part of the request, it is just an explanation.
            </p>
            <h5>Request by client (web browser)</h5>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Mandatory header row</p>
                </div>
                <div class="col">
                    <pre><code class="language-http">
                        POST http://localhost:8080/rest/foo HTTP/1.1
                    </code></pre>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Header parameters:</p>
                    <p style="text-align: right"><em>(Containing optional connection status, requested content type
                        etc.</em>)</p>
                </div>
                <div class="col">
                    <pre><code class="language-http">
                         Host: localhost:8080
                         Cookie: USER_TOKEN=6e70a6b2-66be-4ac4-9f9e-dba1d1e6386d
                         Accept: */*
                         Content-Type: application/json;charset=utf-8
                         Content-Length: 15
                         Connection: keep-alive
                    </code></pre>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Response body (as JSON)</p>
                </div>
                <div class="col">
                    <pre><code class="language-javascript">{"payload":"a"}</code></pre>
                </div>
            </div>
            <h5>Response by the server</h5>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Mandatory header row</p>
                </div>
                <div class="col">
                    <pre><code class="language-http">
                        HTTP/1.1 201 OK
                    </code></pre>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Additional headers</p>
                </div>
                <div class="col">
                    <pre><code class="language-http">
                        Content-Length: 57
                        Content-Type: application/json;charset=utf-8
                        Date: Fri, 04 May 2018 07:17:48 GMT
                        Server: Jetty(9.4.9.v20180320)
                    </code></pre>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <p style="text-align: right">Response body (as JSON)</p>
                </div>
                <div class="col">
                    <pre><code class="language-javascript">
                        {"id":1,"userId":1,"payload":"a","created":1525418268449}
                    </code></pre>
                </div>
            </div>

            <p>
                For more information about HTTP see the
                <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP" target="_blank">Mozilla HTTP
                    reference</a>.
            </p>

            <div class="alert alert-info">
                <b>Note!</b> Your code will not send such HTTP requests/responses directly. Libraries are used to
                send the correct header and body in the right format. However, you still need to know which verbs/codes
                to use in the design of your API.
            </div>

            <h4>HTTP Verbs</h4>
            <p>A description of some of the HTTP verbs follow, you will not need any more than these.</p>
            <dl class="row">
                <dt class="col-sm-3"><code>GET</code></dt>
                <dd class="col-sm-9">Fetches a resource. It may not have a request body.
                    This method should not change anything on the server.
                </dd>
                <dt class="col-sm-3"><code>PUT</code></dt>
                <dd class="col-sm-9">Replaces the resource at a URI with the one in the request body.</dd>
                <dt class="col-sm-3"><code>POST</code></dt>
                <dd class="col-sm-9">Sends general information to the server.</dd>
                <dt class="col-sm-3"><code>DELETE</code></dt>
                <dd class="col-sm-9">Deletes the resource at a specific URI.</dd>
            </dl>

            <h4>HTTP Status Codes</h4>
            <p>
                HTTP status codes follow a pattern, where the first digit indicate the type of status.
                <code>2XX</code> is ok, <code>3XX</code> indicates further action is needed by the client,
                <code>4XX</code> indicates the client has made some error, and finally <code>5XX</code> indicates
                the server has made some error.
            </p>
            <dl class="row">
                <dt class="col-sm-3"><code>200</code> OK and <code>204</code> OK (No Content)</dt>
                <dd class="col-sm-9">Everything went as planned. <code>200</code> is expected for a <code>GET</code>.
                </dd>
                <dt class="col-sm-3"><code>201</code> Created</dt>
                <dd class="col-sm-9">Like <code>OK</code>, but used when a new resource is created.</dd>
                <dt class="col-sm-3"><code>400</code> Bad Request</dt>
                <dd class="col-sm-9">The client has made an error in the request, such as bad syntax. A catch all
                    for client bugs.
                </dd>
                <dt class="col-sm-3"><code>404</code> Not Found</dt>
                <dd class="col-sm-9">The resource specified by the URI cannot be found.</dd>
                <dt class="col-sm-3"><code>403</code> Forbidden</dt>
                <dd class="col-sm-9">The client is not authorized to peform the operation.</dd>
                <dt class="col-sm-3"><code>500</code> Internal Server Error</dt>
                <dd class="col-sm-9">Something went wrong with the server. A catch all for server bugs.</dd>
            </dl>
            <h4>Fetch in JavaScript </h4>
            <p>
                In JavaScript the <code>fetch</code> function is used by BASE for all HTTP requests. These calls are
                made in the script file <a href="/rest.js" target="_blank">rest.js</a>. See
                <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank">here</a> for
                complete documentation of the fetch function.
            </p>
        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="JSON"></a>
            <h3>JSON</h3>
            <p>
                JavaScript Object Notation (JSON) is a popular data-interchange format. It is a sub-set of
                JavaScript, with primarily functions removed. JSON is used to
                <a href="https://en.wikipedia.org/wiki/Serialization" target="_blank">serialize</a>
                data, so that that it can be sent in a structured form between the client and server.
                JavaScript support JSON through built-in functions. Also, JSON is human readable
                (see <a href="/rest/user" target="_blank">/rest/user</a> for an example).
                However, in Java we need a supporting library
                <a href="https://github.com/google/gson" target="_blank">Gson</a>
                to provide this functionality. The <code>JsonProvider.java</code> class in
                <code>server/src/main/java/se/lth/base/server/rest/providers/</code> has the necessary glue to connect
                Gson with the rest of the server code. As such, the specifics of this serialization and deserialization
                will be mostly hidden from students during the project.
            </p>
            <p>
                Here is a demonstration of the JavaScript built-in support for JSON.
            </p>
            <pre><code class="language-javascript">
                const obj = {'a': 1, 'list': [1,2,3]};
                const serialized = JSON.stringify(obj);
                console.log(serialized);
                const deserializedObj = JSON.parse(serialized);
            </code></pre>
            <p>
                The result of evaluating this in a JavaScript console is not very exciting, essentially a string
                representation of the original object:
            </p>
            <code class="language-javascript">'{"a":1,"list":[1,2,3]}'</code>
        </section>

        <div class="lab-task-group alert alert-warning" id="restDefinition">
            <h4 class="alert-heading">
                What is REST?
            </h4>
            <p>
            </p>
            <div class="lab-task-form">
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restDefinition', 1)" class="form-check-input" type="radio"
                               name="restDefinition">
                        A networking protocol to transfer data between clients and servers.
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restDefinition', 2)" class="form-check-input" type="radio"
                               name="restDefinition">
                        An architectural style with principles and constraints guidelines.
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restDefinition', 3)" class="form-check-input" type="radio"
                               name="restDefinition">
                        A data-interchange format for serializing data.
                    </label>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>

        <div class="lab-task-group alert alert-warning" id="restVerb">
            <h4 class="alert-heading">
                Which HTTP verb should be used to create a new resource with unknown identifier?
            </h4>
            <p>
            </p>
            <div class="lab-task-form">
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restVerb', 1)" class="form-check-input" type="radio"
                               name="restVerb">
                        GET
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restVerb', 2)" class="form-check-input" type="radio"
                               name="restVerb">
                        POST
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restVerb', 3)" class="form-check-input" type="radio"
                               name="restVerb">
                        PUT
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('restVerb', 4)" class="form-check-input" type="radio"
                               name="restVerb">
                        PUT or POST
                    </label>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>
                    Right. POST is used in general to send information to the server. PUT is only used to update a
                    resource with a known identifier.
                </p>
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>
    </section>


    <!--  ***********************************************************************************************
          REST in Java
          *********************************************************************************************** -->
    <section class="lab-section language-java">
        <a class="anchor" name="JettyJersey"></a>
        <h1>Jetty and Jersey</h1>
        <p>
            Jetty is an HTTP web server written in Java. Jetty is configured and started in the
            <code>server/src/main/java/se/lth/base/server/BaseServer.java</code> class. In Jetty, each request goes
            through handlers. Jersey is one such handler, registered under the <code>/rest</code> prefix. Another
            handler is configured to serve all the static content under the webassets folder in
            <code>server/src/main/resources/webassets</code>.
        </p>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="JerseyResources"></a>
            <h3 class="mt-4">Jersey Resources</h3>
            <p>
                Jersey is a layer above Java web servers that makes it easy to implement REST APIs. Jersey is the
                reference
                implementation of a standard called
                <a href="https://en.wikipedia.org/wiki/Java_API_for_RESTful_Web_Services" target="_blank">JAX-RS</a>.
                Here
                is the complete
                <a href="https://jersey.github.io/documentation/latest/index.html" target="_blank">Jersey
                    documentation</a>,
                in particular the chapter on
                <a href="https://jersey.github.io/documentation/latest/jaxrs-resources.html"
                   target="_blank">resources</a>
                serves as a more detailed complement to this section. REST resources in Jersey are created as normal
                Java objects, decorated with annotations. Annotations in Java is syntactic meta-data that can be
                interpreted by code. An example of an annotation that you might have seen through auto generated code is
                the <code>@Override</code> annotation, which signals to the Java compiler that the method overrides a
                method from a super class. In Jersey, the annotations are used to map HTTP requests to Java methods.
            </p>
            <p>
                To map an HTTP request to a Java method, the path and an HTTP verb is mandatory. The annotation
                <code>@Path("value")</code>, can be added to classes and methods. Path on class level is added as a
                prefix to all method annotations. Each HTTP verb has a corresponding annotation, such as
                <code>@GET</code>. Classes that have these annotations are called resources (from the resource concept
                in REST). See this example that is used for foo in BASE:
            </p>
            <p>
                In the HTTP specification the data format is referred to as the media type but it is confusingly set
                through the Content-Type header. As such, in Jersey, the name MediaType is used. The annotations for
                media type are different depending on if it is output or input. For input, use <code>@Consumes</code>,
                for output, use <code>@Produces</code>.
            </p>
            <pre><code>
                @Path("foo")                     // Tells Jersey to route request to "foo" to this resource.
                public class FooResource {
                    @GET                            // HTTP verb to match.
                    @Produces("application/json")   // Sets the "Content-Type: application/json" header,
                                                    // So that the web browser knows how to interpret the data.
                    public List&lt;Foo&gt; getFoos() {
                        // The method returns normal Java objects.
                        return ...;
                    }
                }
            </code></pre>
            <p>
                It will match HTTP requests conforming to <code>GET /rest/foo</code>. The prefix <code>/rest</code>
                is added globally in the BaseServer initialization code. The example returns
                <code>List&lt;Foo&gt;</code>, which will be converted to an HTTP body by Jersey.
                The status code will be <code>200</code>. The serialization of the object to <a href="#JSON">JSON</a> is
                explained in the previous section.
            </p>
            <p>
                In the example above only the class itself had the <code>@Path</code> annotation, but it could have been
                added to the method as well. This is needed for example if there are two different methods with
                <code>@GET</code> in the same class.
            </p>

            <h3>Path Parameters</h3>
            <p>
                It is often necessary to extract data from the URI to identify which resource is used. Jersey has
                support for this using the <code>@PathParam</code> annotation. The value of the <code>@PathParam</code>
                should be equal to something in the <code>@Path</code> within curly brackets. The example above will
                extract an integer from the path.
            </p>
            <pre><code>
                @DELETE
                @Path("{id}")
                public void deleteFoo(@PathParam("id") int id) {
                   // Do something with id here ...
                }
            </code></pre>
            <p>
                When adding this method to the FooResource class defined above, it will match HTTP requests such as
                this: <code>DELETE /rest/foo/3</code>. Non-integer values such as
                <code>DELETE /rest/foo/foo</code> will not match.
            </p>

            <h3>Jersey Context</h3>
            <p>
                The resource classes, like FooResource, are created by Jersey for each request. For some requests it
                is necessary to know which user performs the request, such as getting the users information. This is
                available in the ContainerRequestContext. To add this to your class add a constructor where the
                parameter is annotated with the <code>@Context</code> annotation. This pattern is called
                <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a>. For more
                information on how this is implemented, see the optional section on authentication and authorization in
                BASE. Below is an example:
            </p>
            <pre><code>
                public class FooResource {
                    private final User user;

                    public FooResource(@Context ContainerRequestContext context) {
                        this.user = (User) context.getProperty(User.class.getSimpleName());
                    }
                }
            </code></pre>
        </section>

        <div class="lab-task-group alert alert-warning" id="jerseyResource">
            <h4 class="alert-heading">In Jersey, what is a resource?</h4>
            <div class="lab-task-form">
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyResource', 1)" class="form-check-input" type="radio"
                               name="jerseyResource">
                        A method with <code>@Path</code> annotation.
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyResource', 2)" class="form-check-input" type="radio"
                               name="jerseyResource">
                        A method with <code>@Path</code> and HTTP verb annotation.
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyResource', 3)" class="form-check-input" type="radio"
                               name="jerseyResource">
                        A class with <code>@Path</code> annotation and method(s) with HTTP verb annotation(s).
                    </label>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>

        <div class="lab-task-group alert alert-warning" id="jerseyPath">
            <h4 class="alert-heading">What URI will the method in this resource match?</h4>
            <pre><code>
                @Path("/rest/foo")
                public FooResource {
                    @Path("all")
                    @GET
                    public List&lt;Foo&gt; getFoos() {
                        // ...
                    }
                }
            </code></pre>
            <div class="lab-task-form">
                <div class="form-check">
                    <form onsubmit="return jerseyPathValidate(event)" class="lab-task-form">
                        <div class="form-group">
                            <input class="form-control" type="text" placeholder="/path/to/resource" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Validate</button>
                    </form>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>

        <div class="lab-task-group alert alert-warning" id="jerseyExample">
            <h4 class="alert-heading">
                Which of the following HTTP requests will match getUser below?
            </h4>
            <pre><code class="language-java">
                    @Path("rest/user")
                    public class UserResource {
                        @Path("{id}")
                        @Produces("application/json")
                        @GET
                        public User getUser(@PathParam("id") int userId) {
                            throw new WebApplicationException("Not implemented yet", 500);
                        }
                    }
                </code></pre>
            <div class="lab-task-form">
                <p>HTTP version is omitted from the headers.</p>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyExample', 1)" class="form-check-input" type="radio"
                               name="jerseyExample">
                        <code>GET /rest/user/id</code>
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyExample', 2)" class="form-check-input" type="radio"
                               name="jerseyExample">
                        <code>GET /2</code>
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyExample', 3)" class="form-check-input" type="radio"
                               name="jerseyExample">
                        <code>GET /rest/user/3</code>
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyExample', 4)" class="form-check-input" type="radio"
                               name="jerseyExample">
                        <code>GET /user/4</code>
                    </label>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>

        <div class="lab-task-group alert alert-warning" id="jerseyPathParam">
            <h4 class="alert-heading">What is the correct path annotation</h4>
            <p>The resource should match <code>POST</code> requests to e.g. URI <code>/rest/foo/4</code>.</p>
            <p>The method accepts JSON data (which is available in the second parameter below as <code>Foo foo</code>).
            </p>
            <pre><code class="language-java">
                @Path("rest/foo")
                public class FooResource {

                    @Path(  /* 1. What should go here? */ )
                    @Consumes("application/json")
                    @POST
                    public void updateFoo(@PathParam( /* 2. and here */ ) int fooId, Foo foo) {
                        throw new WebApplicationException("Not implemented yet", 500);
                    }
                }
            </code></pre>
            <div class="lab-task-form">
                <p>HTTP version is omitted from the headers.</p>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyPathParam', 1)" class="form-check-input" type="radio"
                               name="jerseyPathParam">
                        <ol>
                            <li><code>"{fooId}"</code></li>
                            <li><code>"fooId"</code></li>
                        </ol>
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyPathParam', 2)" class="form-check-input" type="radio"
                               name="jerseyPathParam">
                        <ol>
                            <li>Nothing, remove the annotation</li>
                            <li><code>"fooId"</code></li>
                        </ol>
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input onclick="baseLab.complete('jerseyPathParam', 3)" class="form-check-input" type="radio"
                               name="jerseyPathParam">
                        <ol>
                            <li><code>"fooId"</code></li>
                            <li><code>"{fooId}"</code></li>
                        </ol>
                    </label>
                </div>
            </div>
            <div class="lab-task-completed">
                <hr>
                <p>Right.
            </div>
            <div class="mt-3 lab-task-error alert alert-danger">
                Incorrect, try again.
            </div>
        </div>

        <section class="lab-section-optional alert alert-info">
            <details>
                <summary>Customizing HTTP Responses in Jersey</summary>
                <p>
                    If an HTTP response should set a specific HTTP header or return a different status code than
                    <code>200</code>, then Jersey offers a few alternatives.
                    First of all, you can return a Response instead of your plain Java object. The Response class has
                    methods to set headers, status code, and a body. Use it like this:
                </p>
                <pre><code>
                    @POST
                    @Path("{id}")
                    @Produces("application/json")
                    public Response addFoo(@PathParam("id") int id, FooPrototype payload) {
                        Foo foo = ... ;
                        return Response.status(201)
                                .header("Location", "localhost:8080/rest/foo/13")
                                .entity(foo)
                                .build();
                    }
                </code></pre>
                <p>
                    This example return the HTTP status code <code>201 Created</code> and returns an URI with the
                    address of the newly created object. The return type of the method is changed from Foo to
                    Response, otherwise the annotations do not need to change. This example is nice and uses the most
                    specific HTTP correct status code. However, returning <code>200 OK</code> and not using Response
                    would be totally fine for your project as well.
                </p>
                <p>
                    On a side note, the code above is an example of the
                    <a href="https://en.wikipedia.org/wiki/Builder_pattern" target="_blank">builder pattern</a>,
                    used to build complex objects. It is quite commonly used by libraries in Java.
                </p>
                <p>
                    Another reason for changing HTTP status codes is for error handling. Throwing an arbitrary exception
                    from a Jersey resource will be intercepted by an <code>ExceptionMapper</code> and turned into a
                    proper HTTP response. In BASE, this is the responsibility of
                    <code>server/src/main/java/se/lth/base/server/rest/providers/JsonExceptionMapper.java</code>. It has
                    special handling for <code>WebApplicationException</code> and
                    <code>DataAccessException</code> (thrown by the database code). The WebApplicationException is built
                    into JAX-RS and can be used to set a specific error code. You can see this in action by doing a
                    request to <a href="http://localhost:8080/rest/nothing" target="_blank">/rest/nothing</a>, Jersey
                    will find to find a match for this resource and throw a WebApplicationException with code
                    <code>404</code>.
                    Your code can also throw <code>WebApplicationException</code>. An example of this follows, consider
                    an implementation of the <code>deleteFoo</code> method:
                </p>
                <pre><code>
                    if(!database.hasFoo(id)) {
                        // This will set the HTTP status code of the response to 404 Not Found.
                        throw new WebApplicationException("Foo not found", 404);
                    }
                </code></pre>
            </details>
        </section>

        <section class="lab-section-optional alert alert-info">
            <details>
                <summary>Authentication and Authorization in BASE</summary>
                <p>
                    <em>Authentication</em> is the process of proving identity, that is login to the system.
                    <em>Authorization</em> is the function of specifying access rights to resources.
                    Only the REST API under the <code>/rest</code> is protected by authorization, the static content
                    in the <code>webassets</code> folder is not sensitive information.
                </p>
                <p>
                    In BASE, authentication is done through a <code>POST</code> request with username and password to
                    the URI <code>/rest/user/login</code>. If the username and password matches what is stored in the
                    database the server will set a cookie to a randomly generated big number (a so called
                    <em>token</em>). This value will be stored in the database and in the client.
                    The server instructs the client to store the cookie through an HTTP header parameter like this:
                    <code>USER_TOKEN=bc9a4966-cec1-46bc-b0ad-8fa093a64960;Domain=localhost;Path=/rest</code>.
                    The client will then pass this token around to every request it does to BASE going forward.
                </p>
                <p>
                    In the front end the login is done by the login script:
                    <a target="_blank" href="http://localhost:8080/login/login.js">/login/login.js</a>. The script is
                    loaded by the file:
                    <a target="_blank" href="http://localhost:8080/login/login.html">/login/login.html</a>.
                    Additionally, when a user first arrives to the root index page, the code performs a request to get
                    the current user. If that request fails, the frontend redirects to the login HTML page.
                </p>
                <p>
                    As the server receives requests with the token, it will match the token with what it has stored in
                    the database and see which user it matches. The advantage of this approach is that the client does
                    not have to send the username and password to the server for every request, it is sufficient to send
                    the cookie. Thus, the client does not need to <em>store</em> the actual password, leading to a more
                    secure solution. It should be noted that the solution is still vulnerable to man-in-the-middle
                    attacks unless the network is encrypted through HTTPS.
                </p>
                <p>
                    User authentication of already logged in users is handled by the class
                    <code>base/src/main/java/se/leth/base/server/rest/providers/AuthenticationFilter.java</code>. It
                    intercepts all requests entering the REST API, performs a database lookup of the cookie value and
                    sets the user and session information for the rest of the request cycle. A User and Session Java
                    object is added to the ContainerRequestContext, which can be injected through the
                    <code>@Context</code> annotation when needed.
                </p>
                <p>
                    Authorization is included in the JAX-RS standard, through the <code>@RolesAllowed</code> annotation.
                    All resources in BASE are annotated with either <code>@RolesAllowed("USER")</code> or
                    <code>@RolesAllowed("ADMIN")</code>. The implementation uses the SecurityContext interface (the
                    Session class in BASE implements this interface). It has the method <code>boolean
                    isUserInRole(String role){...}</code>, which is called with the string specified by the
                    <code>@RolesAllowed</code> annotation.
                </p>
                <p>
                    BASE uses the RoleAllowedDynamicFeature from Jersey for authorization implementation.
                </p>
            </details>
        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="JerseyTest"></a>

            <h3 class="mt-4">Jersey Unit Tests</h3>
            <p>
                Since Jersey resources are plain Java objects, they can be created directly and tested using normal
                method invocations. This would not test that the Jersey annotations (<code>@Path</code>,
                <code>@GET</code>, etc.) are correct. To do testing of these, Jersey has a unit testing module,
                consisting of a light-weight server and a REST client. See
                <code>server/src/test/java/se/lth/base/server/FooResourceTest.java</code>
                for how unit testing is implemented for the FooResource class. In short, extend from the
                <code>BaseResourceTest.java</code> to setup a temporary in-memory server and database for each unit
                test. This class in turn extends from <code>JerseyTest.java</code>, it exposes the
                <a href="https://jersey.github.io/documentation/latest/client.html" target="_blank">
                    Jersey client API starting with
                </a> the method <code>target</code>.
            </p>
            <div>
                Here is an excerpt from the class, that tests that a request for users foo when there are none should
                return an empty list (in contrast to crashing).
                <pre><code class="language-java">
                    public class FooResourceTest extends BaseResourceTest {
                        @Test
                        public void getNoFooData() {
                            List&lt;Foo&gt; list = target("foo").request().get(new GenericType&lt;List&lt;Foo&gt;&gt;() {});
                            assertTrue(list.isEmpty());
                        }
                    }
                </code></pre>
            </div>

        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="Lifecycle"></a>
            <h3>A Request Lifecycle</h3>
            <p>
                By now we have enough information to understand the complete lifecycle of a request that enters the
                server. Here we give the complete back end picture.
                When the web front end performs a request to the server, the request goes through a standardized
                process. First, Jetty routes the request to the correct handler (static files or Jersey), then the
                handler generates an HTTP response that the web front end receives. When Jersey services a request it
                has additional routing to specific resources, such as FooResource. Below is an example of a request
                to fetch user with id 2 foo data, that is to
                <a href="http://localhost:8080/rest/foo/user/2"
                   target="_blank">http://localhost:8080/rest/foo/user/2</a>.
            </p>
            <p>
                The request in the example is defined by this Jersey resource and method.
            </p>
            <pre><code class="language-java">
                @Path("foo")
                public class FooResource {
                    private final FooDataAccess fooDao = new FooDataAccess(Config.instance().getDatabaseDriver());
                    @GET
                    @Produces(MediaType.APPLICATION_JSON + ";charset=utf-8")
                    @RolesAllowed(Role.Names.ADMIN)
                    @Path("user/{userId}")
                    public List&lt;Foo&gt; getUsersFoos(@PathParam("userId") int userId) {
                        return fooDao.getUsersFoo(userId);
                    }
                }
            </code></pre>
            <p>
                In the example below, blue boxes are classes defined in BASE, and red boxes are Jetty and Jersey
                library code.
            </p>
            <div class="row no-gutters">
                <div class="col-4 d-flex flex-column">
                    <div class="mt-3">
                        <div class="row no-gutters">
                            <div class="col">
                                <b class="p-3">Request</b>
                            </div>
                            <div class="col-7">
                                <img class="img-fluid" src="arrow.svg">
                            </div>
                        </div>
                        <pre><code class="m-3 mr-5 language-http">
                        GET /rest/foo/user/2 HTTP/1.1
                    </code></pre>
                    </div>
                    <div class="mt-auto">
                    <pre><code class="m-3 mr-5 language-http">
                        HTTP/1.1 200 OK
                    </code></pre>
                        <pre><code class="m-3 mr-5 language-json">
                            [
                                {
                                    "id":2,
                                    "userId":2,
                                    "payload":"foo",
                                    "created":123012310,
                                    "total":3
                                }
                            ]
                        </code></pre>
                        <div class="row no-gutters">
                            <div class="col">
                                <b class="p-3">Response</b>
                            </div>
                            <div class="col-7">
                                <img class="img-fluid" src="arrow.svg" style="transform: rotate(180deg)">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border p-2 col-8" style="background-color: hsl(0, 59%, 88%)">
                    <h4>Jetty (configured by BaseServer.java)</h4>
                    <ol>
                        <li>
                            Jetty receives the request and routes <code>/rest</code> to Jersey, as defined in
                            <code>BaseServer.java</code>.
                        </li>
                    </ol>
                    <div class="border p-2 m-3" style="background-color: hsl(0, 59%, 94%)">
                        <h4>Jersey (configured by BaseServer.java)</h4>
                        <ol start="2">
                            <li>
                                Jersey finds the request filter that performs authentication.
                            </li>
                        </ol>
                        <div class="border p-2 m-3" style="background-color: hsl(195, 59%, 88%)">
                            <h4>AuthenticationFilter.java</h4>
                            <ol start="3">
                                <li>
                                    The filter is executed, see the optional section in <a href="#REST">REST</a> for
                                    more information. In short, authentication concerns figuring out which user performs
                                    the request (corresponding to a row in the user table).
                                </li>
                            </ol>
                        </div>
                        <ol start="4">
                            <li>
                                Jersey handles the request and routes <code>/foo</code> to FooResource.java. The
                                correct method is found by matching the <code>/user/2</code> path and <code>GET</code>-verb.
                            </li>
                            <li>
                                Jersey performs authorization, in this case the user must be logged in with the role
                                ADMIN. As mentioned, the technicalities of authorization is described in a previous
                                optional section. In short, authorization concerns whether the user has the required
                                permission for the request.
                            </li>
                            <li>
                                Jersey creates an object of the <code>FooResource.java</code> class and calls the
                                method <code>getUsersFoo</code> with the path-parameter <code>2</code>.
                            </li>
                        </ol>
                        <div class="border p-2 m-3" style="background-color: hsl(195, 59%, 88%)">
                            <h4>FooResource.java</h4>
                            <ol start="5">
                                <li>
                                    Method <code>getUsersFoo(2): List&lt;Foo&gt;</code> calls the data access layer,
                                    using the users id: 2. For now, this method only passes data around for the data
                                    access layer. If needed, the method might perform input sanitation, handling
                                    optional parameters, or setting different HTTP status codes.
                                </li>
                            </ol>
                            <div class="border p-2 m-3" style="background-color: hsl(195, 59%, 96%)">
                                <h4>FooDataAccess.java</h4>
                                <ol start="8">
                                    <li>Method <code>getUsersFoo(2): List&lt;Foo&gt;</code> calls H2 database
                                        with an SQL statement:
                                    </li>
                                </ol>
                                <pre><code class="language-sql">
                                SELECT * FROM foo
                                WHERE user_id = ?
                            </code></pre>
                                <ol start="9">
                                    <li>
                                        The database returns a ResultSet which is converted to a plain Java object using
                                        the FooMapper: <code>List&lt;Foo&gt;</code>.
                                    </li>
                                </ol>
                            </div>
                        </div>
                        <ol start="10">
                            <li>
                                Jersey looks for a provider that can serialize JSON, which will be the
                                <code>JsonProvider.java</code> class.
                            </li>
                        </ol>
                        <div class="border p-2 m-3" style="background-color: hsl(195, 59%, 88%)">
                            <h4>JsonProvider.java</h4>
                            <ol start="11">
                                <li>
                                    JSON is serialized through a single method call to the GSON library. The result from
                                    GSON is written to an output stream that is written to the client.
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </section>

    <!--  ***********************************************************************************************
          Modifying Back End
          *********************************************************************************************** -->
    <section class="lab-section">
        <a class="anchor" name="E2E"></a>
        <h1>Continuing the End to End Task</h1>
        <p>
            We will now continue the last task in the previous lab, the one that added the total field to foo. If you
            completed this on another computer you will need to re-implement the changes of the
            <a href="/labs/lab1.html#E2E">previous lab</a>.
        </p>
        <p>
            The task will be to add <q>increment</q> and <q>decrement</q> buttons next to each total cell in the table.
            When these buttons are pressed there should be a call to the REST server to update the field. If the total
            reaches 0, the row should be removed.
        </p>

        <div class="alert alert-primary">
            <h4 class="alert-heading">Hint!</h4>
            <p>All the tasks marked with <code>TODO:</code> are expected to be solved with <b>one</b> line.</p>
        </div>

        <!--<section class="lab-sub-section">
            <h3>General Troubleshooting</h3>
            <a class="sub-anchor" name="Troubleshooting"></a>
        </section>-->

        <section class="lab-sub-section">
            <a class="sub-anchor" name="BackEndChanges"></a>
            <h3>Back End Changes</h3>

            <div class="alert alert-info">
                <h4 class="alert-heading">Updating database schema</h4>
                <p>
                    The first step is to add a new column to foo.
                </p>
                <ol>
                    <li>Open the schema.sql file.</li>
                    <li>Add the column total to the foo table's CREATE TABLE statement.</li>
                </ol>
                <pre><code class="language-sql">
                    total INT NOT NULL DEFAULT 1
                </code></pre>
                <ol start="3">
                    <li>Add the following constraint to ensure data integrity of the database. Add the constraint at the
                        same location that KEYS are defined. It will make sure total is always at least 1 (otherwise the
                        row shall be deleted).
                    </li>
                </ol>
                <pre><code class="language-sql">
                    CHECK (total > 0)
                </code></pre>
                <ol start="4">
                    <li>Run the jUnit test and make sure that they pass!</li>
                    <li>
                        First, make sure the server is closed for this step (to release the database lock). Then,
                        run the CreateSchema.java file to re-install the database.
                    </li>
                </ol>

            </div>

            <div class="alert alert-info">
                <h4 class="alert-heading">Adding total to the Java object</h4>
                <ol>
                    <li>Open Foo.java</li>
                    <li>Add constructor parameter <code>int total</code> that stores total in the corresponding field.</li>
                    <li>Add method <code>getTotal()</code> to Foo.</li>
                    <li>Update the Mapper in FooDataAccess.java to also handle <q>total</q>.</li>
                    <li>Update the <code>addFoo</code> method, add a <q>1</q> to the constructor call of Foo.</li>
                    <li>Run the jUnit test and make sure that they pass!</li>
                </ol>
            </div>

            <div class="alert alert-info">
                <h4 class="alert-heading">Adding update and delete methods to the data layer</h4>

                <ol>
                    <li>Open FooDataAccess.java</li>
                    <li>Implement <code>deleteFoo</code> and copy <code>updateTotal</code> from below:</li>
                </ol>
                <pre><code class="language-java">
                    /**
                     * Delete a users foo row.
                     *
                     * @param userId user to match.
                     * @param fooId primary key of the foo.
                     * @return true if a row was deleted.
                     */
                     public boolean deleteFoo(int userId, int fooId) {
                        // TODO: Please implement this one
                        return false;
                    }

                    /**
                     * Update the total column of a foo.
                     *
                     * @param userId user to match.
                     * @param fooId primary key of the foo.
                     * @param newTotal value to set the column to.
                     * @return true if a row was updated.
                     */
                    public boolean updateTotal(int userId, int fooId, int newTotal) {
                        return execute("UPDATE foo SET total = ? WHERE user_id = ? AND foo_id = ?", newTotal, userId, fooId) > 0;
                    }
                </code></pre>
                <ol start="3">
                    <li>Open FooDataAccessTest.java</li>
                    <li>Add the jUnit tests below and implement the basic test for deleteFoo.</li>
                </ol>
                <pre><code class="language-java">
                    @Test
                    public void deleteFoo() {
                        int userId = 2;
                        Foo foo = fooDao.addFoo(userId, "data");
                        // TODO: Please finish this implementation
                        // it should call the deleteFoo method and check its returned value
                        // assertTrue(...)
                    }

                    @Test
                    public void itShouldNotBePossibleToDeleteOthersFoo() {
                        int userId = 1;
                        Foo foo = fooDao.addFoo(userId, "data");
                        // Even though we provide the same foo id, the method should fail to delete here since the user id is different
                        int otherUserId = 2;
                        assertFalse(fooDao.deleteFoo(otherUserId, foo.getId()));
                    }

                    @Test
                    public void deleteMissingFoo() {
                        // No foo has been added yet, so the foo with id = 1 should not exist
                        int userId = 1;
                        int fooId = 1;
                        assertFalse(fooDao.deleteFoo(userId, fooId));
                    }

                    @Test
                    public void updateFooTotal() {
                        int userId = 2;
                        Foo foo = fooDao.addFoo(userId, "data");
                        fooDao.updateTotal(userId, foo.getId(), 4);
                        assertEquals(4, fooDao.getUsersFoo(userId).get(0).getTotal());
                    }

                    @Test
                    public void itShouldNotBePossibleToUpdateOthersFoo() {
                        int userId = 1;
                        int fooId = 1;
                        int total = 1;
                        assertFalse(fooDao.updateTotal(userId, fooId, total));
                    }

                    @Test(expected = DataAccessException.class)
                    public void failUpdateToZero() {
                        int userId = 1;
                        Foo foo = fooDao.addFoo(userId, "will go to zero");
                        fooDao.updateTotal(userId, foo.getId(), 0);
                    }
                </code></pre>
                <ol start="4">
                    <li>Run the tests again and enjoy watching them pass!</li>
                </ol>
            </div>

            <div class="alert alert-info">
                <h4 class="alert-heading">Adding POST and DELETE methods to the REST API</h4>
                <ol>
                    <li>Open FooResource.java</li>
                    <li>Implement the following methods:</li>
                </ol>
                <pre><code class="language-java">
                    @POST
                    @RolesAllowed(Role.Names.USER)
                    @Path("{fooId}/total/{newTotal}")
                    public void updateFoo(@PathParam("fooId") int fooId, @PathParam("newTotal") int newTotal) {
                        if (!fooDao.updateTotal(user.getId(), fooId, newTotal)) {
                            throw new WebApplicationException(404);
                        }
                    }

                    // Implement this method and add correct annotations
                    // It should match HTTP calls like this:
                    // DELETE /rest/foo/4
                    @DELETE
                    @RolesAllowed(Role.Names.USER)
                    // TODO: please add @Path annotation
                    public void deleteFoo( /* TODO: please add @PathParam annotation for the fooId */) {
                        // TODO: please call the correct method in fooDao
                    }
                </code></pre>
                <ol start="3">
                    <li>Open FooResourceTest.java</li>
                    <li>Implement jUnit tests according to this specification:</li>
                </ol>
                <pre><code class="language-java">
                    @Test
                    public void updateFoo() {
                        Foo foo = target("foo")
                                .request()
                                .post(Entity.json(Collections.singletonMap("payload", "new foo")), Foo.class);
                        target("foo")
                                .path(Integer.toString(foo.getId()))
                                .path("total")
                                .path(Integer.toString(42))
                                .request()
                                .post(Entity.json(null));
                        List&lt;Foo&gt; foos = target("foo").request().get(new GenericType&lt;List&lt;Foo&gt;&gt;(){});
                        assertEquals(42, foos.get(0).getTotal());
                    }

                    @Test
                    public void deleteFoo() {
                        Foo foo = target("foo")
                                .request()
                                .post(Entity.json(Collections.singletonMap("payload", "new foo")), Foo.class);
                        target("foo")
                                .path(Integer.toString(foo.getId()))
                                .request()
                                .delete();
                        List&lt;Foo&gt; foos = target("foo").request().get(new GenericType&lt;List&lt;Foo&gt;&gt;(){});
                                // TODO: please finish the implementation with an assertion on foos
                    }
                </code></pre>
                <ol start="5">
                    <li>Run the tests again and enjoy watching them pass!</li>
                    <li>Restart the server when done.</li>
                </ol>
            </div>

            <div class="alert alert-warning lab-task-group" id="e2eBackEnd">
                <h4 class="alert-heading">Validate your implementation</h4>
                <div>You need to be logged in to <a href="http://localhost:8080/" target="_blank">base</a> validate.</div>
                <div class="lab-task-form">
                    <button class="btn btn-primary" onclick="e2eBackEndValidate()">Validate</button>
                </div>
                <div class="lab-task-completed">
                    <hr>
                    <p>
                        Right, well done!
                    </p>
                </div>
                <div class="mt-3 lab-task-error alert alert-danger">
                    Incorrect, try again.
                </div>
            </div>
        </section>

        <section class="lab-sub-section">
            <a class="sub-anchor" name="FrontEndChanges"></a>
            <h3>Front End Changes</h3>

            <div class="alert alert-info">
                <h4 class="alert-heading">Add buttons</h4>
                <div>
                    These buttons <span class="btn-group m-3">
                    <button class="btn btn-primary btn-sm">-</button>
                    <button class="btn btn-primary" disabled>42</button>
                    <button class="btn btn-primary btn-sm">+</button>
                </span> can be added with the following HTML code:
                </div>
                <pre class="p-3"><code class="language-html">
                    &lt;div class="btn-group"&gt;
                        &lt;button class="btn btn-primary btn-sm"&gt;-&lt;/button&gt;
                        &lt;button class="btn btn-primary" disabled&gt;&lt;/button&gt;
                        &lt;button class="btn btn-primary btn-sm"&gt;+&lt;/button&gt;
                    &lt;/div&gt;
                </code></pre>
                <ol>
                    <li>Open foo.html</li>
                    <li>Add the buttons to the <code>&lt;td&gt;</code>-tag of the <q>total</q> column.</li>
                    <li>Open foo.js</li>
                    <li>
                        Replace the previous assignment to <code>tds[2]</code> with something that sets the textContent
                        of the middle button.
                    </li>
                </ol>
                <pre><code class="language-javascript">
                    const buttons = tds[2].querySelectorAll('button');
                    // TODO: do something with buttons[1]
                </code></pre>
                <ol start="5">
                    <li>Add this to the end of the <code>render</code> function on the FooViewModel here:
                        <code>// TODO: Add stuff from lab 2, end-2-end task here</code>
                    </li>
                </ol>
                <pre><code class="language-javascript">
                     this.fooRow = clone.querySelector('tr');

                     const buttons = clone.querySelectorAll('button');

                     // This function is called with the response from the server
                     const updateFoo = function(newTotal) {
                         viewModel.foo.total = newTotal;
                         viewModel.update(viewModel.fooRow);
                     };

                     // Decrement button onclick function
                     buttons[0].onclick = function(event) {
                         if (viewModel.foo.total == 1) {
                             base.rest.deleteFoo(viewModel.foo.id).then(function() {
                                 viewModel.fooRow.parentElement.removeChild(viewModel.fooRow);
                             });
                         } else {
                             base.rest.updateFoo(viewModel.foo.id, viewModel.foo.total - 1).then(updateFoo);
                         }
                     };
                     // Increment button onclick function
                     buttons[2].onclick = function() {
                        // TODO: complete this (look at the decrement button).
                     };
                </code></pre>
                <ol start="6">
                    <li>Restart the server and make sure that the buttons are working.</li>
                </ol>
            </div>
            <p>That's it for the end to end task.</p>
        </section>

        <div class="alert alert-info mt-5">
            <h4 class="alert-heading">Present to your TA</h4>
            Show that <b>all tasks in this lab</b> are completed and that the <b>jUnit tests pass</b>. Also be prepared
            to show that the increment and decrement buttons are working as intended in
            <a href="/#/foo" target="_blank">foo</a>. Don't forget to ask any remaining questions.
        </div>

    </section>

    <div class="lab-section">
        <b>P.s.</b> the total number of validation errors during your lab session was <span id="score"></span>.
    </div>
</div>
</body>
</html>
